<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RE-LIFE - Catálogo</title>
    <link rel="stylesheet" href="css/styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <header class="navbar">
        <div class="logo"><span class="re-white">RE</span>LIFE</div>
        <div class="welcome-user">Cargando...</div>
        <button class="logout-btn">Cerrar Sesión</button>
    </header>

    <main class="content">
        <div class="product-catalog">
            
            <%# 1. BUCLE PARA MOSTRAR CATEGORÍAS Y PRODUCTOS %>
            <% Object.keys(categories).forEach(catName => { %>
                <% const categoryData = categories[catName]; %>
                
                <section class="product-section">
                    <div class="section-header">
                        <h2><%= catName %></h2>
                        <a href="/category/<%= categoryData.id %>" class="view-more">Ver más &rarr;</a>
                    </div>

                    <div class="product-grid">
                        <% categoryData.products.slice(0, 6).forEach((producto) => { %>
                            <div class="product-item" onclick="verDetalleProducto(<%= producto.tdp_id %>)" style="cursor: pointer;">
                                <img src="<%= producto.timg_url || 'https://via.placeholder.com/150?text=Sin+Foto' %>" alt="<%= producto.tdp_nmb %>">
                                <p><%= producto.tdp_nmb %></p>
                                <p class="price">$ <%= producto.tdp_pre %></p>
                            </div>
                        <% }) %>
                    </div>
                </section>
                <hr style="border: 0; border-top: 1px solid #333; margin: 20px 0;">
            <% }) %>

            <%# 2. MENSAJE SI NO HAY PRODUCTOS %>
            <% if (Object.keys(categories).length === 0) { %>
                <div style="text-align: center; padding: 50px; color: #fff;">
                    <h3>No se encontraron productos.</h3>
                    <p>Intenta cambiar los filtros de búsqueda.</p>
                </div>
            <% } %>

        </div>

        <aside class="sidebar">
            <div class="account-box">
                <i class="fas fa-user-circle"></i>
                <a href="/user" class="btn-profile">Tu Cuenta</a>
            </div>
            
            <button class="publish-btn" onclick="window.location.href='/publish'">Publicar tu Prenda</button>
            
            <div class="filter-group">
                <h3>Categoría</h3>
                <select class="category-select" id="filter-category">
                    <option value="">Todas las categorías</option>
                    <% if (typeof allCategories !== 'undefined') { %>
                        <% allCategories.forEach(cat => { %>
                            <option value="<%= cat.tct_id %>" 
                                <%= (typeof filters !== 'undefined' && filters.categoryId == cat.tct_id) ? 'selected' : '' %>>
                                <%= cat.tct_nmb %>
                            </option>
                        <% }) %>
                    <% } %>
                </select>
            </div>
            
            <div class="filter-group">
                <h3>Rango de Precio</h3>
                <div class="price-range">
                    <input type="number" id="filter-min" placeholder="Min" 
                           value="<%= (typeof filters !== 'undefined' && filters.minPrice) ? filters.minPrice : '' %>">
                    <span>-</span>
                    <input type="number" id="filter-max" placeholder="Max" 
                           value="<%= (typeof filters !== 'undefined' && filters.maxPrice) ? filters.maxPrice : '' %>">
                </div>
            </div>
            
            <button class="filter-btn" id="btn-apply-filter">Filtrar</button>
            
            <% if (typeof filters !== 'undefined' && (filters.categoryId || filters.minPrice || filters.maxPrice)) { %>
                <button class="filter-btn" onclick="window.location.href='/'" style="background-color: #555; margin-top: 5px;">Limpiar Filtros</button>
            <% } %>
        </aside>
    </main>

    <%- include('partials/footer') %>

    <script src="js/main.js"></script>
    <script>
        function verDetalleProducto(id) {
            const usuarioLogueado = localStorage.getItem('userEmail');
            if (usuarioLogueado) {
                window.location.href = '/product/' + id;
            } else {
                const deseaIrAlLogin = confirm('Debes iniciar sesión para ver los detalles.\n\n¿Quieres ir a Iniciar Sesión ahora?');
                if (deseaIrAlLogin) {
                    window.location.href = '/login';
                } 
            }
        }
    </script>
</body>
</html>