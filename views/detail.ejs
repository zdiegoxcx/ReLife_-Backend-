<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= product.tdp_nmb %> - ReLife</title>
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="stylesheet" href="/css/detail.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>

    <header class="navbar">
        <div class="logo"><a href="/"><span class="re-white">RE</span>LIFE</a></div>
        <div class="welcome-user" id="user-display">Cargando...</div>
        <a href="/" class="logout-btn" style="text-decoration: none;">Volver al Inicio</a>
    </header>

    <main class="main-container">
        <div class="detail-grid">
           
            <div class="card image-card">
                <div class="deco-line top-green"></div>
                
                <% if (images && images.length > 1) { %>
                    <div class="nav-arrow left" id="prev-btn"><i class="fas fa-caret-left"></i></div>
                    <div class="nav-arrow right" id="next-btn"><i class="fas fa-caret-right"></i></div>
                <% } %>

                <div class="product-image-container">
                    <img id="main-image" 
                         src="<%= (images && images.length > 0) ? images[0].timg_url : 'https://via.placeholder.com/400?text=Sin+Foto' %>" 
                         alt="<%= product.tdp_nmb %>">
                </div>

                <% if (images && images.length > 1) { %>
                    <div class="thumbnails-row">
                        <% images.forEach((img, index) => { %>
                            <img src="<%= img.timg_url %>" 
                                 class="thumb-img <%= index === 0 ? 'active' : '' %>" 
                                 onclick="changeImage(<%= index %>)">
                        <% }) %>
                    </div>
                <% } %>

                <div class="deco-line bottom-green"></div>
            </div>

            <div class="card info-card">
                <div class="vertical-green-line"></div>

                <h1 class="product-title"><%= product.tdp_nmb %></h1>
                <p class="category-label">Categoría: <%= product.categoria %></p>

                <div class="price-block">
                    <span class="price-large">$ <%= product.tdp_pre %></span>
                    
                    <% if (product.tdp_est) { %>
                        <span class="status-text" style="color: #38c172; border-color: #38c172;">Disponible</span>
                    <% } else { %>
                        <span class="status-text" style="color: #dc3545; border-color: #dc3545;">Agotado</span>
                    <% } %>
                </div>

                <hr class="divider">

                <div class="info-section">
                    <h3>Descripción</h3>
                    <p><%= product.tdp_des %></p>
                    <p><strong>Talla:</strong> <%= product.ttal_tipo %> <%= product.ttal_valor %></p>
                </div>

                <hr class="divider">

                <div class="info-section">
                    <h3>Contacto</h3>
                    <p><strong>Contacto:</strong> <%= product.vendedor_contacto %></p>
                    <p>Email: <%= product.vendedor_email %></p>
               </div>

                <hr class="divider">

                <div class="seller-profile-box">
                    Ver perfil del vendedor: 
                    <a href="/profile/<%= product.vendedor_email %>" class="seller-link">
                         <%= product.vendedor_nombre %> <%= product.vendedor_apellido %>
                    </a>
                </div>

            </div>
        </div>
    </main>

    <%- include('partials/footer') %>

    <script>
        // 1. Mostrar usuario en header
        document.addEventListener('DOMContentLoaded', () => {
            const userEmail = localStorage.getItem('userEmail');
            const display = document.getElementById('user-display');
            if(userEmail && display) {
                display.textContent = 'BIENVENIDO ' + userEmail.split('@')[0].toUpperCase();
            }
        });

        // 2. Lógica del Carrusel de Imágenes
        // Pasamos el array de imágenes del servidor a una variable JS
        const productImages = <%- JSON.stringify(images || []) %>;
        let currentIndex = 0;
        
        const mainImg = document.getElementById('main-image');
        const thumbs = document.querySelectorAll('.thumb-img');

        function updateGallery() {
            // Cambiar imagen principal
            if(productImages.length > 0) {
                mainImg.src = productImages[currentIndex].timg_url;
                
                // Actualizar borde verde de la miniatura activa
                thumbs.forEach((t, i) => {
                    if (i === currentIndex) t.classList.add('active');
                    else t.classList.remove('active');
                });
            }
        }

        // Función para flecha "Siguiente"
        const nextBtn = document.getElementById('next-btn');
        if(nextBtn) {
            nextBtn.addEventListener('click', () => {
                currentIndex++;
                if (currentIndex >= productImages.length) currentIndex = 0; // Volver al inicio
                updateGallery();
            });
        }

        // Función para flecha "Anterior"
        const prevBtn = document.getElementById('prev-btn');
        if(prevBtn) {
            prevBtn.addEventListener('click', () => {
                currentIndex--;
                if (currentIndex < 0) currentIndex = productImages.length - 1; // Ir al final
                updateGallery();
            });
        }

        // Función para clic directo en miniatura (llamada desde el HTML)
        function changeImage(index) {
            currentIndex = index;
            updateGallery();
        }
    </script>
</body>
</html>